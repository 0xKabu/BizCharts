<html>
  <head>
    <script src="https://unpkg.com/react@15.6.2/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@15.6.2/dist/react-dom.min.js"></script>
    <script src="https://cdn.bootcss.com/babel-core/5.8.38/browser.min.js"></script>
    <script src="https://unpkg.com/bizcharts@3.0.3/umd/BizCharts.min.js"> </script>
    <script type="text/javascript" src="https://gw.alipayobjects.com/as/g/datavis/assets/1.0.5/data-set/0.6.2/data-set.min.js"></script>
    <script type="text/javascript" src="https://gw.alipayobjects.com/as/g/datavis/assets/1.0.1/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="https://a.alipayobjects.com/g/datavis/china-geojson/1.0.0/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
  </head>
  <body>
      <div id="mountNode" ></div>
      <script type="text/babel">
       $('#mountNode').html('<div style="position:relative;padding-left:250px;">' +
        '<div id="china" style="position: absolute;top:5px;left:5px;"></div>' +
        '<div id="province"></div>' +
      '</div>');
      const { Chart, Geom, Axis, Tooltip, Coord, Label, Legend, View, Guide, Shape, G2 } = window.BizCharts;

      function processData(mapData) {
          // 构造虚拟数据
          const userData = [];
          const features = mapData.features;
          for (let i = 0; i < features.length; i++) {
              const name = features[i].properties.name;
              userData.push({
                  name: name,
                  value: Math.round(Math.random() * 1000),
              });
          }
          const ds = new DataSet();
          const geoDataView = ds.createView().source(mapData, {
              type: 'GeoJSON',
          }); // geoJSON 经纬度数据

          // 用户数据
          const dvData = ds.createView().source(userData);
          dvData.transform({
              type: 'geo.region',
              field: 'name',
              geoDataView: geoDataView,
              as: ['longitude', 'lantitude'],
          });

          return dvData;
      }

      const mapData = ChinaGeoJSON['China'];
      const chinaDv = processData(mapData);
      const longitudeRange = chinaDv.range('longitude');
      const lantitudeRange = chinaDv.range('lantitude');
      const ratio = (longitudeRange[1] - longitudeRange[0]) / (lantitudeRange[1] - lantitudeRange[0]);


   class App extends React.Component {
     constructor(props) {
       super(props);

       this.state = {

       };
     }

     renderProvinceChart(name) {
      if(document.getElementById("realContainer")) {
        ReactDOM.unmountComponentAtNode(document.getElementById("realContainer"));
      }
      const provinceData = ChinaGeoJSON[name];

      // provinceChart && provinceChart.destroy();
      if (!provinceData) {
        return;
      }
      const dv = processData(provinceData);
      // start: 计算地图的最佳宽高
      const longitudeRange = dv.range('longitude');
      const lantitudeRange = dv.range('longitude');
      const ratio2 = (longitudeRange[1] - longitudeRange[0]) / (lantitudeRange[1] - lantitudeRange[0]);

      let width;
      let height;
      if (ratio2 > 1) {
        width = 450;
        height = width / ratio2;
      } else {
        width = 350 * ratio2;
        height = 350;
      }

      // end: 计算地图的最佳宽高

      ReactDOM.render((
        <div id="realContainer">
           <Chart data={dv} width={width} height={height} padding={0} >
             <Geom position='longitude*lantitude'
               style={{
                stroke: '#fff',
                lineWidth: 1,
              }}
              color = {['value', '#BAE7FF-#1890FF-#0050B3']}
             />
           </Chart>
        </div>
      ), document.getElementById("province"));

     }

     onGetG2Ins(chart) {
       const shapes = chart.getAllGeoms()[0].getShapes();
       for (let i = 0, len = shapes.length; i < len; i++) {
         const shape = shapes[i];
         const origin = shape.get('origin')['_origin'];
         const name = origin.name;
         if (name === '浙江') {
           this.renderProvinceChart(name);
           chart.getAllGeoms()[0].setShapeSelected(shape);
         }
       }
     }

     onPlotClick(ev) {
      const shape = ev.shape;
      if (!shape || !shape.name) {
        return false;
      }
      if (shape.get('selected')) {
        const item = shape.get('origin');
        const data = item['_origin'];
        const name = data.name;
        this.renderProvinceChart(name);
      } else {
        provinceChart && provinceChart.clear();
      }
     }

     render() {
       return (
       <Chart height={250/ratio} container='china' width={250} data={chinaDv}
          padding={0} animate={false}
          onGetG2Instance={this.onGetG2Ins.bind(this)}
          onPlotClick={this.onPlotClick.bind(this)}
        >
          <Tooltip showTitle={false} />
          <Geom
            type='polygon'
            position='longitude*lantitude'
            select={{
              // 设置是否允许选中以及选中样式
              mode: 'single', // 多选还是单选
                style: {
                  fill: '#1890ff', // 选中的样式
                },
                }}
            tooltip='name'
            style={{lineWidth: 1,globalAlpha: 0.9,cursor: 'pointer',stroke: '#999',fill: '#ccc'}}
            color={['count', [ 'rgb(200, 200, 255)', 'rgb(0, 0, 255)' ]]}
            />
        </Chart>
       );
     }

   }

   ReactDOM.render((<App />), document.getElementById("china"))
    </script>
  </body>
</html>